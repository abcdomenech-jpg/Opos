<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El meu Generador de Tests IA</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg-color: #f4f4f9; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --accent: #6366f1; --accent-hover: #4f46e5; --success: #22c55e; --success-light: #dcfce7; --danger: #ef4444; --danger-light: #fee2e2; --border: #e2e8f0; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .view { display: none; } .view.active { display: block; }
        button { cursor: pointer; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; padding: 12px 20px; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: white; width: 100%; margin-top: 10px; }
        .btn-secondary { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger-light); color: var(--danger); font-size: 0.8rem; padding: 5px 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); position: relative; }
        .drop-zone { border: 2px dashed var(--accent); border-radius: var(--radius); padding: 40px; text-align: center; background: rgba(99, 102, 241, 0.05); margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 10px; background: var(--border); border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .option-btn { background: var(--surface); border: 2px solid var(--border); padding: 15px; border-radius: var(--radius); text-align: left; width: 100%; margin-bottom: 10px; display: block; font-size: 1rem; }
        .option-btn.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
        .option-btn.correct { background: var(--success-light); border-color: var(--success); }
        .option-btn.wrong { background: var(--danger-light); border-color: var(--danger); }
        .hidden { display: none !important; }
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .admin-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="hidden">
    <div style="border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <h3 id="loadingText" style="margin-top: 20px;">Processant...</h3>
</div>

<div class="container">
    <div class="admin-controls">
        <h1>Els meus Tests</h1>
        <button class="btn-secondary" onclick="toggleAdmin()" id="btnAdmin">üîì Login Admin</button>
    </div>

    <div id="view-dashboard" class="view active">
        <div class="drop-zone hidden" id="adminZone">
            <h3>Pujar nou PDF</h3>
            <p>Selecciona un PDF per generar preguntes autom√†ticament</p>
            <input type="file" id="fileInput" accept="application/pdf" style="display:none">
            <button class="btn-primary" style="width:auto" onclick="document.getElementById('fileInput').click()">Tria el fitxer PDF</button>
        </div>
        <div id="testList" class="grid"></div>
    </div>

    <div id="view-config" class="view">
        <h2 id="configTestName">Configuraci√≥</h2>
        <div class="card">
            <label>Mode de joc:</label>
            <select id="configMode" style="width:100%; padding:10px; margin: 10px 0;">
                <option value="practice">Mode Pr√†ctica (Correcci√≥ instant√†nia)</option>
                <option value="exam">Mode Examen (Resultats al final)</option>
            </select>
            <button class="btn-primary" onclick="startTest()">Comen√ßar</button>
            <button class="btn-secondary" style="width:100%; margin-top:10px" onclick="switchView('dashboard')">Enrere</button>
        </div>
    </div>

    <div id="view-test" class="view">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <h2 id="questionText" style="margin-bottom:20px"></h2>
        <div id="optionsGrid"></div>
        <div id="explanationBox" class="card hidden" style="margin-top:20px; background:#f1f5f9; border-left: 4px solid var(--accent);"></div>
        <div style="margin-top:30px; display:flex; gap:10px">
            <button id="btnPrev" class="btn-secondary" style="flex:1" onclick="prevQuestion()">Anterior</button>
            <button id="btnNext" class="btn-primary" style="flex:2" onclick="nextQuestion()">Seg√ºent</button>
            <button id="btnSubmit" class="btn-primary hidden" style="flex:2" onclick="finishTest()">Entregar Test</button>
        </div>
    </div>

    <div id="view-results" class="view">
        <div class="card" style="text-align:center">
            <h1 id="resultScore" style="font-size:5rem; color:var(--accent)">0%</h1>
            <p id="resultDetails" style="margin-bottom:20px"></p>
            <button class="btn-primary" onclick="switchView('dashboard')">Tornar a l'Inici</button>
        </div>
    </div>
</div>

<script>
// ==========================================
// CONFIGURACI√ì (MODIFICA AIX√í)
// ==========================================
const MI_PASS = "132465"; 
const GEMINI_KEY = "AIzaSyAVTj-VTbM97lL2oYiVa00W5HKUIAA8OKg";

const firebaseConfig = {
  apiKey: "AIzaSyAYJ3reH4R2FCzmtc7qVgSevnKePP5ySsM",
  authDomain: "tests-opos.firebaseapp.com",
  projectId: "tests-opos",
  storageBucket: "tests-opos.firebasestorage.app",
  messagingSenderId: "166341509112",
  appId: "1:166341509112:web:e3840650f9f8131bdc200d"
};

// ==========================================
// INICIALITZACI√ì
// ==========================================
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function toggleAdmin() {
    if (localStorage.getItem('is_admin') === 'true') {
        localStorage.removeItem('is_admin');
        location.reload();
    } else {
        const p = prompt("Contrasenya d'Admin:");
        if (p === MI_PASS) {
            localStorage.setItem('is_admin', 'true');
            location.reload();
        } else { alert("Incorrecta"); }
    }
}

const esAdmin = localStorage.getItem('is_admin') === 'true';
if(esAdmin) {
    document.getElementById('adminZone').classList.remove('hidden');
    document.getElementById('btnAdmin').innerText = "üîí Logout Admin";
}

// ==========================================
// L√íGICA DE DADES
// ==========================================
async function getTests() {
    const snap = await db.collection('meus_tests').get();
    return snap.docs.map(doc => doc.data());
}

async function deleteTest(id) {
    if(confirm("Segur?")) {
        await db.collection('meus_tests').doc(id).delete();
        renderDashboard();
    }
}

// ==========================================
// PROCESSAMENT PDF I IA
// ==========================================
document.getElementById('fileInput').onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    showLoader("Llegint PDF...");
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(it => it.str).join(" ") + " ";
        }

        showLoader("Gemini est√† creant les preguntes...");
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Act as a teacher. Create a multiple choice test from this text. Return ONLY a JSON array with this structure: [{"question": "...", "options": ["A", "B", "C", "D"], "correctIndex": 0, "explanation": "..."}]. Text: ${text.substring(0, 20000)}` }] }]
            })
        });

        const data = await response.json();
        let rawText = data.candidates[0].content.parts[0].text;
        
        // NETEJA EXTREMA DEL JSON
        const start = rawText.indexOf('[');
        const end = rawText.lastIndexOf(']');
        const cleanJson = JSON.parse(rawText.substring(start, end + 1));

        const newTest = {
            id: crypto.randomUUID(),
            name: file.name.replace(".pdf", ""),
            questions: cleanJson,
            stats: { attempts: 0, bestScore: 0 }
        };

        await db.collection('meus_tests').doc(newTest.id).set(newTest);
        hideLoader();
        renderDashboard();
    } catch (err) {
        console.error(err);
        alert("Error al processar: " + err.message);
        hideLoader();
    }
};

// ==========================================
// INTERF√çCIE (UI)
// ==========================================
async function renderDashboard() {
    const list = document.getElementById('testList');
    list.innerHTML = "Carregant tests...";
    const tests = await getTests();
    
    if(tests.length === 0) { list.innerHTML = "No hi ha tests. Puja un PDF per comen√ßar."; return; }

    list.innerHTML = tests.map(t => `
        <div class="card">
            <h3>${t.name}</h3>
            <p style="color:var(--text-muted)">${t.questions.length} preguntes</p>
            <button class="btn-primary" onclick="openConfig('${t.id}')">Fer Test</button>
            ${esAdmin ? `<button class="btn-danger" style="margin-top:10px" onclick="deleteTest('${t.id}')">Esborrar</button>` : ''}
        </div>
    `).join('');
}

let activeTest = null;
let currentIdx = 0;
let userAnswers = [];

function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + id).classList.add('active');
}

async function openConfig(id) {
    const tests = await getTests();
    activeTest = tests.find(t => t.id === id);
    document.getElementById('configTestName').innerText = activeTest.name;
    switchView('config');
}

function startTest() {
    currentIdx = 0;
    userAnswers = new Array(activeTest.questions.length).fill(null);
    switchView('test');
    renderQuestion();
}

function renderQuestion() {
    const q = activeTest.questions[currentIdx];
    document.getElementById('questionText').innerText = (currentIdx + 1) + ". " + q.question;
    document.getElementById('progressFill').style.width = ((currentIdx + 1) / activeTest.questions.length) * 100 + "%";
    
    const grid = document.getElementById('optionsGrid');
    grid.innerHTML = q.options.map((opt, i) => `
        <button class="option-btn ${userAnswers[currentIdx] === i ? 'selected' : ''}" onclick="selectOpt(${i})">${opt}</button>
    `).join('');

    document.getElementById('explanationBox').classList.add('hidden');
    document.getElementById('btnPrev').disabled = (currentIdx === 0);
    
    const isLast = (currentIdx === activeTest.questions.length - 1);
    document.getElementById('btnNext').classList.toggle('hidden', isLast);
    document.getElementById('btnSubmit').classList.toggle('hidden', !isLast);

    if(document.getElementById('configMode').value === 'practice' && userAnswers[currentIdx] !== null) {
        showFeedback();
    }
}

function selectOpt(i) {
    userAnswers[currentIdx] = i;
    renderQuestion();
}

function showFeedback() {
    const q = activeTest.questions[currentIdx];
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach((b, i) => {
        if(i === q.correctIndex) b.classList.add('correct');
        else if(i === userAnswers[currentIdx]) b.classList.add('wrong');
        b.style.pointerEvents = "none";
    });
    const exp = document.getElementById('explanationBox');
    exp.innerText = "üí° " + q.explanation;
    exp.classList.remove('hidden');
}

function nextQuestion() { currentIdx++; renderQuestion(); }
function prevQuestion() { currentIdx--; renderQuestion(); }

function finishTest() {
    let correct = 0;
    activeTest.questions.forEach((q, i) => { if(userAnswers[i] === q.correctIndex) correct++; });
    const score = Math.round((correct / activeTest.questions.length) * 100);
    document.getElementById('resultScore').innerText = score + "%";
    document.getElementById('resultDetails').innerText = `Has encertat ${correct} de ${activeTest.questions.length} preguntes.`;
    switchView('results');
}

function showLoader(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoader() { document.getElementById('loadingOverlay').classList.add('hidden'); }

window.onload = renderDashboard;
</script>
<style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
</body>
</html>
