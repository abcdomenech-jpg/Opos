<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El meu Generador de Tests IA</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg-color: #f4f4f9; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --accent: #6366f1; --accent-hover: #4f46e5; --success: #22c55e; --success-light: #dcfce7; --danger: #ef4444; --danger-light: #fee2e2; --border: #e2e8f0; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .view { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view.active { display: block; opacity: 1; }
        h1 { font-size: 2rem; margin-bottom: 1rem; }
        button { cursor: pointer; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; padding: 12px 20px; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger-light); color: var(--danger); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        .drop-zone { border: 2px dashed var(--accent); border-radius: var(--radius); padding: 30px; text-align: center; background: rgba(99, 102, 241, 0.05); margin-bottom: 20px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 10px; }
        .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .options-grid { display: grid; gap: 10px; margin-top: 20px; }
        .option-btn { background: var(--surface); border: 2px solid var(--border); padding: 15px; border-radius: var(--radius); text-align: left; }
        .option-btn.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
        .option-btn.correct { background: var(--success-light); border-color: var(--success); }
        .option-btn.wrong { background: var(--danger-light); border-color: var(--danger); }
        .hidden { display: none !important; }
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .admin-lock { text-align: right; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="hidden">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <h3 id="loadingText" style="margin-top: 15px;">Processant...</h3>
</div>

<div class="container">
    <div class="admin-lock">
        <button class="btn-secondary" onclick="loginAdmin()" id="btnAdmin"> Admin</button>
    </div>

    <div id="view-dashboard" class="view active">
        <h1>Els meus Tests</h1>
        <div class="drop-zone hidden" id="adminZone">
            <h3>Pujar nou PDF</h3>
            <input type="file" id="fileInput" accept="application/pdf" style="display:none">
            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Seleccionar Arxiu</button>
        </div>
        <div id="testList" class="grid"></div>
    </div>

    <div id="view-config" class="view">
        <h1 id="configTestName">Configuraci贸</h1>
        <div class="card">
            <label>Mode:</label>
            <select id="configMode" class="form-control">
                <option value="practice">Prctica (Saber l'error al moment)</option>
                <option value="exam">Examen (Resultats al final)</option>
            </select>
            <button class="btn-primary" style="width:100%" onclick="startTest()">Comen莽ar Test</button>
            <button class="btn-secondary" style="width:100%; margin-top:10px" onclick="switchView('dashboard')">Enrere</button>
        </div>
    </div>

    <div id="view-test" class="view">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <h3 id="questionText"></h3>
        <div id="optionsGrid" class="options-grid"></div>
        <div id="explanationBox" class="card hidden" style="margin-top:20px; background:#f8fafc"></div>
        <div style="margin-top:30px; display:flex; justify-content:space-between">
            <button id="btnPrev" class="btn-secondary" onclick="prevQuestion()">Anterior</button>
            <button id="btnNext" class="btn-primary" onclick="nextQuestion()">Seg眉ent</button>
            <button id="btnSubmit" class="btn-primary hidden" onclick="finishTest()">Finalitzar</button>
        </div>
    </div>

    <div id="view-results" class="view">
        <div class="card" style="text-align:center">
            <h1 id="resultScore" style="font-size:4rem; color:var(--accent)">0%</h1>
            <p id="resultDetails"></p>
            <button class="btn-primary" onclick="switchView('dashboard')">Tornar a l'Inici</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURACI PRIVADA ---
const CONTRASENYA_ADMIN = "132465"; // <--- CANVIA AIX!

const firebaseConfig = {
  apiKey: "AIzaSyAYJ3reH4R2FCzmtc7qVgSevnKePP5ySsM",
  authDomain: "tests-opos.firebaseapp.com",
  projectId: "tests-opos",
  storageBucket: "tests-opos.firebasestorage.app",
  messagingSenderId: "166341509112",
  appId: "1:166341509112:web:e3840650f9f8131bdc200d"
};

// Inicialitzaci贸
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Gesti贸 d'acc茅s
function loginAdmin() {
    const pass = prompt("Introdueix la contrasenya d'administrador:");
    if (pass === CONTRASENYA_ADMIN) {
        localStorage.setItem('es_admin', 'true');
        location.reload();
    } else {
        alert("Contrasenya incorrecta");
    }
}

const esAdmin = localStorage.getItem('es_admin') === 'true';
if(esAdmin) {
    document.getElementById('adminZone').classList.remove('hidden');
    document.getElementById('btnAdmin').innerText = " Sortir Admin";
    document.getElementById('btnAdmin').onclick = () => {
        localStorage.removeItem('es_admin');
        location.reload();
    };
}

// L貌gica de dades
const Storage = {
    getTests: async () => {
        const snap = await db.collection('meus_tests').get();
        return snap.docs.map(doc => doc.data());
    },
    saveTest: async (t) => await db.collection('meus_tests').doc(t.id).set(t),
    deleteTest: async (id) => {
        if(confirm("Segur que vols esborrar-lo?")) {
            await db.collection('meus_tests').doc(id).delete();
            renderDashboard();
        }
    }
};

// Motor de PDF i IA
async function handleFiles(e) {
    const file = e.target.files[0];
    const key = localStorage.getItem('gemini_api_key') || prompt("Introdueix la teva Gemini API Key:");
    if(!key) return;
    localStorage.setItem('gemini_api_key', key);

    showLoader("Llegint PDF i enviant a Gemini...");
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(it => it.str).join(" ");
        }

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
            method: 'POST',
            body: JSON.stringify({ contents: [{ parts: [{ text: `Analyze this text and generate a multiple choice test in JSON format [ { "question": "", "options": ["","","",""], "correctIndex": 0, "explanation": "" } ]. Text: ${text}` }] }] })
        });
        
        const data = await res.json();
        let rawJson = data.candidates[0].content.parts[0].text;
        const cleanJson = JSON.parse(rawJson.substring(rawJson.indexOf('['), rawJson.lastIndexOf(']') + 1));

        const test = { id: crypto.randomUUID(), name: file.name.replace('.pdf',''), questions: cleanJson, stats: {attempts:0, bestScore:0} };
        await Storage.saveTest(test);
        hideLoader();
        renderDashboard();
    } catch(err) {
        alert("Error: " + err.message);
        hideLoader();
    }
}

document.getElementById('fileInput').onchange = handleFiles;

// UI i Navegaci贸
function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + id).classList.add('active');
}

async function renderDashboard() {
    const tests = await Storage.getTests();
    const list = document.getElementById('testList');
    list.innerHTML = tests.map(t => `
        <div class="card">
            <h3>${t.name}</h3>
            <p>${t.questions.length} preguntes</p>
            <div style="margin-top:10px">
                <button class="btn-primary" onclick="openConfig('${t.id}')">Obrir</button>
                ${esAdmin ? `<button class="btn-danger" onclick="Storage.deleteTest('${t.id}')">Esborrar</button>` : ''}
            </div>
        </div>
    `).join('');
}

let activeTest = null;
let currentIdx = 0;
let userAnswers = [];

async function openConfig(id) {
    const tests = await Storage.getTests();
    activeTest = tests.find(t => t.id === id);
    document.getElementById('configTestName').innerText = activeTest.name;
    switchView('config');
}

function startTest() {
    currentIdx = 0;
    userAnswers = new Array(activeTest.questions.length).fill(null);
    switchView('test');
    renderQuestion();
}

function renderQuestion() {
    const q = activeTest.questions[currentIdx];
    document.getElementById('questionText').innerText = q.question;
    document.getElementById('progressFill').style.width = ((currentIdx+1)/activeTest.questions.length)*100 + "%";
    
    const grid = document.getElementById('optionsGrid');
    grid.innerHTML = q.options.map((opt, i) => `
        <button class="option-btn ${userAnswers[currentIdx] === i ? 'selected' : ''}" onclick="selectOpt(${i})">${opt}</button>
    `).join('');

    document.getElementById('explanationBox').classList.add('hidden');
    document.getElementById('btnPrev').classList.toggle('hidden', currentIdx === 0);
    const isLast = currentIdx === activeTest.questions.length - 1;
    document.getElementById('btnNext').classList.toggle('hidden', isLast);
    document.getElementById('btnSubmit').classList.toggle('hidden', !isLast);

    if(document.getElementById('configMode').value === 'practice' && userAnswers[currentIdx] !== null) {
        showFeedback();
    }
}

function selectOpt(i) {
    userAnswers[currentIdx] = i;
    renderQuestion();
}

function showFeedback() {
    const q = activeTest.questions[currentIdx];
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach((b, i) => {
        if(i === q.correctIndex) b.classList.add('correct');
        else if(i === userAnswers[currentIdx]) b.classList.add('wrong');
    });
    const exp = document.getElementById('explanationBox');
    exp.innerText = q.explanation;
    exp.classList.remove('hidden');
}

function nextQuestion() { currentIdx++; renderQuestion(); }
function prevQuestion() { currentIdx--; renderQuestion(); }

function finishTest() {
    let correct = 0;
    activeTest.questions.forEach((q, i) => { if(userAnswers[i] === q.correctIndex) correct++; });
    const score = Math.round((correct/activeTest.questions.length)*100);
    document.getElementById('resultScore').innerText = score + "%";
    document.getElementById('resultDetails').innerText = `Has encertat ${correct} de ${activeTest.questions.length} preguntes.`;
    switchView('results');
}

function showLoader(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoader() { document.getElementById('loadingOverlay').classList.add('hidden'); }

window.onload = renderDashboard;
</script>
</body>
</html>
